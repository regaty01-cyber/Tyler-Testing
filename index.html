<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Vision Golf Pro - AI Camera-Based Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: #000;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100vh;
        }

        /* Camera View Container */
        .camera-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }

        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Hidden canvases for processing */
        #processingCanvas,
        #detectionCanvas,
        #ballTrackingCanvas {
            display: none;
        }

        /* AR Overlay */
        .ar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #arCanvas {
            width: 100%;
            height: 100%;
        }

        /* Setup Screen */
        .setup-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .setup-logo {
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
            text-align: center;
        }

        .setup-instructions {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            margin-bottom: 30px;
        }

        .instruction-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            color: white;
        }

        .instruction-number {
            width: 30px;
            height: 30px;
            background: #00ff88;
            color: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .instruction-text {
            font-size: 14px;
            line-height: 1.5;
            opacity: 0.95;
        }

        .camera-placement {
            width: 100%;
            max-width: 350px;
            height: 200px;
            background: rgba(0,0,0,0.3);
            border: 2px dashed #00ff88;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        .placement-icon {
            font-size: 60px;
            margin-bottom: 10px;
        }

        .placement-text {
            color: #00ff88;
            font-size: 14px;
            text-align: center;
        }

        .start-camera-btn {
            background: linear-gradient(135deg, #00ff88, #00ccff);
            color: #000;
            border: none;
            padding: 18px 60px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 10px 30px rgba(0,255,136,0.3);
        }

        /* HUD Overlay */
        .hud {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        /* Top Bar */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .camera-status {
            background: rgba(0,0,0,0.7);
            border: 1px solid #00ff88;
            border-radius: 20px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(0,255,136,0.7); }
            50% { opacity: 0.7; box-shadow: 0 0 0 10px rgba(0,255,136,0); }
        }

        .status-text {
            color: white;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tracking-mode {
            background: rgba(0,0,0,0.7);
            border-radius: 20px;
            padding: 8px 16px;
            color: #00ff88;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        /* Detection Boxes */
        .detection-box {
            position: absolute;
            border: 2px solid #00ff88;
            background: rgba(0,255,136,0.1);
            pointer-events: none;
            transition: all 0.1s ease;
        }

        .detection-label {
            position: absolute;
            top: -25px;
            left: 0;
            background: #00ff88;
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        /* Ball Tracking Indicator */
        .ball-tracker {
            position: absolute;
            border: 3px solid #ff5722;
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(255,87,34,0.6);
        }

        .ball-trail {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ff5722;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.6;
        }

        /* Real-time Metrics Display */
        .metrics-display {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            border: 2px solid #00ff88;
            border-radius: 20px;
            padding: 20px;
            min-width: 350px;
            backdrop-filter: blur(20px);
            display: none;
            pointer-events: auto;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .metric-item {
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0,255,136,0.5);
        }

        .metric-label {
            font-size: 10px;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        /* Swing Analysis Overlay */
        .swing-analysis {
            position: absolute;
            top: 100px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #00ff88;
            border-radius: 15px;
            padding: 15px;
            min-width: 200px;
            display: none;
            backdrop-filter: blur(15px);
        }

        .analysis-title {
            font-size: 14px;
            color: #00ff88;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .analysis-label {
            color: rgba(255,255,255,0.6);
        }

        .analysis-value {
            color: white;
            font-weight: 600;
        }

        /* Recording Controls */
        .recording-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            pointer-events: auto;
        }

        .record-btn {
            width: 80px;
            height: 80px;
            background: #ff5722;
            border: 4px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        .record-btn.recording {
            background: #f44336;
            animation: recordPulse 1s infinite;
        }

        @keyframes recordPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .record-icon {
            width: 30px;
            height: 30px;
            background: white;
            border-radius: 50%;
        }

        .record-btn.recording .record-icon {
            border-radius: 4px;
        }

        /* Calibration Grid */
        .calibration-grid {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 200px;
            border: 2px dashed #00ff88;
            display: none;
            pointer-events: none;
        }

        .calibration-text {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            color: #00ff88;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
        }

        /* Shot Result */
        .shot-result {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 500;
            backdrop-filter: blur(20px);
        }

        .result-card {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #00ff88;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,255,136,0.3);
        }

        .result-title {
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .result-video {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .result-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .result-metric {
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 10px;
        }

        .result-metric-value {
            font-size: 28px;
            font-weight: 700;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .result-metric-label {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
        }

        /* 3D Visualization */
        .visualization-3d {
            position: absolute;
            top: 100px;
            right: 20px;
            width: 300px;
            height: 200px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #00ff88;
            border-radius: 15px;
            display: none;
        }

        #visualization3D {
            width: 100%;
            height: 100%;
            border-radius: 15px;
        }

        /* Club Detection */
        .club-detection {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.8);
            border-radius: 15px;
            padding: 15px;
            display: none;
        }

        .detected-club {
            color: #00ff88;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .club-confidence {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
        }

        /* Settings Menu */
        .settings-menu {
            position: absolute;
            top: 80px;
            right: -300px;
            width: 280px;
            height: calc(100% - 80px);
            background: rgba(0,0,0,0.95);
            border-left: 1px solid #00ff88;
            padding: 20px;
            transition: right 0.3s ease;
            pointer-events: auto;
            overflow-y: auto;
            z-index: 200;
        }

        .settings-menu.open {
            right: 0;
        }

        .settings-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: auto;
        }

        .setting-group {
            margin-bottom: 25px;
        }

        .setting-label {
            color: #00ff88;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .setting-option {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .setting-option:hover {
            background: rgba(0,255,136,0.1);
            border-color: #00ff88;
        }

        .setting-option.active {
            background: rgba(0,255,136,0.2);
            border-color: #00ff88;
        }

        /* Frame Rate Display */
        .fps-counter {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #00ff88;
            font-family: monospace;
        }

        /* Help Overlay */
        .help-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .help-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .help-title {
            font-size: 24px;
            color: #00ff88;
            margin-bottom: 20px;
            text-align: center;
        }

        .help-section {
            margin-bottom: 20px;
        }

        .help-section-title {
            color: #00ccff;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .help-text {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            line-height: 1.6;
        }

        .close-help {
            background: linear-gradient(135deg, #00ff88, #00ccff);
            color: #000;
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Camera Feed -->
    <div class="camera-container">
        <video id="cameraFeed" playsinline autoplay muted></video>
    </div>

    <!-- Processing Canvases (Hidden) -->
    <canvas id="processingCanvas"></canvas>
    <canvas id="detectionCanvas"></canvas>
    <canvas id="ballTrackingCanvas"></canvas>

    <!-- AR Overlay Canvas -->
    <div class="ar-overlay">
        <canvas id="arCanvas"></canvas>
    </div>

    <!-- Setup Screen -->
    <div id="setupScreen" class="setup-screen">
        <div class="setup-logo">VISION GOLF PRO</div>
        <div class="setup-instructions">
            <div class="instruction-item">
                <div class="instruction-number">1</div>
                <div class="instruction-text">Position iPhone 6-8 feet behind ball, at waist height</div>
            </div>
            <div class="instruction-item">
                <div class="instruction-number">2</div>
                <div class="instruction-text">Ensure ball and hitting area are clearly visible</div>
            </div>
            <div class="instruction-item">
                <div class="instruction-number">3</div>
                <div class="instruction-text">Good lighting is essential - outdoors or bright indoor</div>
            </div>
        </div>
        <div class="camera-placement">
            <div class="placement-icon">📱</div>
            <div class="placement-text">Place phone here<br>Behind & slightly elevated</div>
        </div>
        <button class="start-camera-btn" onclick="startCamera()">START CAMERA</button>
    </div>

    <!-- HUD Interface -->
    <div id="hud" class="hud">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="camera-status">
                <div class="status-indicator"></div>
                <span class="status-text">TRACKING ACTIVE</span>
            </div>
            <div class="tracking-mode" id="trackingMode">AI VISION MODE</div>
        </div>

        <!-- FPS Counter -->
        <div class="fps-counter" id="fpsCounter">60 FPS</div>

        <!-- Detection Boxes (Added dynamically) -->
        <div id="detectionBoxes"></div>

        <!-- Ball Tracker (Added dynamically) -->
        <div id="ballTrackers"></div>

        <!-- Swing Analysis -->
        <div id="swingAnalysis" class="swing-analysis">
            <div class="analysis-title">Swing Analysis</div>
            <div class="analysis-item">
                <span class="analysis-label">Tempo:</span>
                <span class="analysis-value" id="swingTempo">3:1</span>
            </div>
            <div class="analysis-item">
                <span class="analysis-label">Path:</span>
                <span class="analysis-value" id="swingPath">In-to-Out</span>
            </div>
            <div class="analysis-item">
                <span class="analysis-label">Face:</span>
                <span class="analysis-value" id="clubFace">Square</span>
            </div>
            <div class="analysis-item">
                <span class="analysis-label">Speed:</span>
                <span class="analysis-value" id="swingSpeed">0 mph</span>
            </div>
        </div>

        <!-- Club Detection -->
        <div id="clubDetection" class="club-detection">
            <div class="detected-club" id="detectedClub">DRIVER</div>
            <div class="club-confidence">Confidence: <span id="clubConfidence">98%</span></div>
        </div>

        <!-- Real-time Metrics -->
        <div id="metricsDisplay" class="metrics-display">
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-value" id="ballSpeed">0</div>
                    <div class="metric-label">Ball Speed</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="launchAngle">0°</div>
                    <div class="metric-label">Launch</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="spinRate">0</div>
                    <div class="metric-label">Spin</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="carryDistance">0</div>
                    <div class="metric-label">Carry</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="clubSpeed">0</div>
                    <div class="metric-label">Club Speed</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="smashFactor">0.00</div>
                    <div class="metric-label">Smash</div>
                </div>
            </div>
        </div>

        <!-- 3D Visualization -->
        <div id="visualization3DContainer" class="visualization-3d">
            <canvas id="visualization3D"></canvas>
        </div>

        <!-- Calibration Grid -->
        <div id="calibrationGrid" class="calibration-grid">
            <div class="calibration-text">Align ball in box</div>
        </div>

        <!-- Recording Controls -->
        <div class="recording-controls">
            <button id="recordBtn" class="record-btn" onclick="toggleRecording()">
                <div class="record-icon"></div>
            </button>
        </div>

        <!-- Settings Toggle -->
        <div class="settings-toggle" onclick="toggleSettings()">⚙️</div>
    </div>

    <!-- Settings Menu -->
    <div id="settingsMenu" class="settings-menu">
        <div class="setting-group">
            <div class="setting-label">Detection Mode</div>
            <div class="setting-option active" onclick="setDetectionMode('auto')">Auto Detect</div>
            <div class="setting-option" onclick="setDetectionMode('ball')">Ball Only</div>
            <div class="setting-option" onclick="setDetectionMode('club')">Club Only</div>
        </div>
        <div class="setting-group">
            <div class="setting-label">Camera Quality</div>
            <div class="setting-option active" onclick="setCameraQuality('high')">High (1080p)</div>
            <div class="setting-option" onclick="setCameraQuality('medium')">Medium (720p)</div>
            <div class="setting-option" onclick="setCameraQuality('low')">Low (480p)</div>
        </div>
        <div class="setting-group">
            <div class="setting-label">Frame Rate</div>
            <div class="setting-option active" onclick="setFrameRate(240)">240 FPS</div>
            <div class="setting-option" onclick="setFrameRate(120)">120 FPS</div>
            <div class="setting-option" onclick="setFrameRate(60)">60 FPS</div>
        </div>
    </div>

    <!-- Shot Result -->
    <div id="shotResult" class="shot-result">
        <div class="result-card">
            <div class="result-title">PERFECT STRIKE!</div>
            <video id="resultVideo" class="result-video" controls></video>
            <div class="result-metrics">
                <div class="result-metric">
                    <div class="result-metric-value" id="resultBallSpeed">165</div>
                    <div class="result-metric-label">Ball Speed (mph)</div>
                </div>
                <div class="result-metric">
                    <div class="result-metric-value" id="resultClubSpeed">113</div>
                    <div class="result-metric-label">Club Speed (mph)</div>
                </div>
                <div class="result-metric">
                    <div class="result-metric-value" id="resultCarry">265</div>
                    <div class="result-metric-label">Carry (yards)</div>
                </div>
                <div class="result-metric">
                    <div class="result-metric-value" id="resultSmash">1.46</div>
                    <div class="result-metric-label">Smash Factor</div>
                </div>
            </div>
            <button class="close-help" onclick="closeResult()">CONTINUE</button>
        </div>
    </div>

    <!-- Help Overlay -->
    <div id="helpOverlay" class="help-overlay">
        <div class="help-content">
            <div class="help-title">How to Use Vision Golf Pro</div>
            <div class="help-section">
                <div class="help-section-title">📱 Camera Setup</div>
                <div class="help-text">Place iPhone 6-8 feet directly behind the ball at waist height. Use a tripod or phone stand for stability.</div>
            </div>
            <div class="help-section">
                <div class="help-section-title">🎯 Ball Detection</div>
                <div class="help-text">The AI automatically detects the golf ball. Green box = detected. Red box = tracking.</div>
            </div>
            <div class="help-section">
                <div class="help-section-title">🏌️ Club Tracking</div>
                <div class="help-text">Club head is tracked through impact zone. AI identifies club type automatically.</div>
            </div>
            <div class="help-section">
                <div class="help-section-title">📊 Metrics</div>
                <div class="help-text">Ball speed, launch angle, and spin are calculated using advanced computer vision algorithms.</div>
            </div>
            <button class="close-help" onclick="closeHelp()">GOT IT</button>
        </div>
    </div>

    <!-- TensorFlow.js for AI Detection -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.0.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1635988162/pose.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        // ==========================================
        // VISION GOLF PRO - AI CAMERA-BASED SIMULATOR
        // Using Computer Vision for Ball & Club Tracking
        // ==========================================
        
        // Global variables
        let video, processingCanvas, detectionCanvas, arCanvas;
        let processingCtx, detectionCtx, arCtx;
        let model, poseDetector;
        let isRecording = false;
        let recordedFrames = [];
        let mediaRecorder, recordedChunks = [];
        
        // Tracking variables
        let ballPosition = null;
        let previousBallPosition = null;
        let ballVelocity = { x: 0, y: 0 };
        let ballTrail = [];
        let clubHeadPosition = null;
        let previousClubPosition = null;
        let clubPath = [];
        let swingStartTime = null;
        let impactDetected = false;
        
        // Calibration data
        let pixelsPerMeter = 500; // Calibrated based on known ball size
        let cameraHeight = 1.2; // meters
        let cameraDistance = 2; // meters from ball
        
        // Frame processing
        let frameCount = 0;
        let fps = 0;
        let lastFrameTime = Date.now();
        
        // Shot data
        let shotData = {
            ballSpeed: 0,
            clubSpeed: 0,
            launchAngle: 0,
            spinRate: 0,
            carryDistance: 0,
            smashFactor: 0,
            swingPath: '',
            clubFace: '',
            tempo: ''
        };
        
        // Initialize camera
        async function startCamera() {
            try {
                // Hide setup screen
                document.getElementById('setupScreen').style.display = 'none';
                document.getElementById('hud').style.display = 'block';
                
                // Get video element
                video = document.getElementById('cameraFeed');
                
                // Setup canvases
                setupCanvases();
                
                // Camera constraints for high frame rate
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 240, min: 60 } // High frame rate for ball tracking
                    }
                };
                
                // Get camera stream
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Wait for video to load
                video.onloadedmetadata = () => {
                    video.play();
                    initializeAI();
                    startProcessing();
                };
                
            } catch (error) {
                console.error('Camera error:', error);
                alert('Camera access denied. Please allow camera access and reload.');
            }
        }
        
        // Setup processing canvases
        function setupCanvases() {
            // Processing canvas
            processingCanvas = document.getElementById('processingCanvas');
            processingCtx = processingCanvas.getContext('2d');
            
            // Detection canvas
            detectionCanvas = document.getElementById('detectionCanvas');
            detectionCtx = detectionCanvas.getContext('2d');
            
            // AR overlay canvas
            arCanvas = document.getElementById('arCanvas');
            arCtx = arCanvas.getContext('2d');
            
            // Set canvas sizes
            const setCanvasSize = () => {
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                processingCanvas.width = width;
                processingCanvas.height = height;
                
                detectionCanvas.width = width;
                detectionCanvas.height = height;
                
                arCanvas.width = width;
                arCanvas.height = height;
            };
            
            setCanvasSize();
            window.addEventListener('resize', setCanvasSize);
        }
        
        // Initialize AI models
        async function initializeAI() {
            try {
                // Load COCO-SSD for object detection
                model = await cocoSsd.load();
                console.log('AI Model loaded');
                
                // Initialize MediaPipe Pose for swing detection
                initializePoseDetection();
                
                // Show calibration grid
                setTimeout(() => {
                    document.getElementById('calibrationGrid').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('calibrationGrid').style.display = 'none';
                    }, 3000);
                }, 1000);
                
            } catch (error) {
                console.error('AI initialization error:', error);
            }
        }
        
        // Initialize pose detection for swing analysis
        function initializePoseDetection() {
            // MediaPipe Pose configuration
            const pose = new Pose({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                }
            });
            
            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            pose.onResults(onPoseResults);
            poseDetector = pose;
        }
        
        // Start video processing loop
        function startProcessing() {
            requestAnimationFrame(processFrame);
        }
        
        // Main processing loop
        async function processFrame() {
            frameCount++;
            
            // Calculate FPS
            const currentTime = Date.now();
            if (currentTime - lastFrameTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFrameTime = currentTime;
                document.getElementById('fpsCounter').textContent = `${fps} FPS`;
            }
            
            // Draw video to processing canvas
            processingCtx.drawImage(video, 0, 0, processingCanvas.width, processingCanvas.height);
            
            // Clear AR canvas
            arCtx.clearRect(0, 0, arCanvas.width, arCanvas.height);
            
            // Detect objects (ball, club)
            await detectObjects();
            
            // Track ball movement
            trackBall();
            
            // Track club movement
            trackClub();
            
            // Detect impact
            detectImpact();
            
            // Draw AR overlays
            drawAROverlays();
            
            // Record frame if recording
            if (isRecording) {
                recordFrame();
            }
            
            // Continue loop
            requestAnimationFrame(processFrame);
        }
        
        // Detect objects using AI
        async function detectObjects() {
            if (!model) return;
            
            try {
                // Run detection
                const predictions = await model.detect(processingCanvas);
                
                // Clear detection boxes
                const boxContainer = document.getElementById('detectionBoxes');
                boxContainer.innerHTML = '';
                
                // Process predictions
                predictions.forEach(prediction => {
                    // Look for sports ball (golf ball)
                    if (prediction.class === 'sports ball' && prediction.score > 0.5) {
                        detectGolfBall(prediction);
                    }
                    
                    // Draw detection box
                    drawDetectionBox(prediction);
                });
                
            } catch (error) {
                console.error('Detection error:', error);
            }
        }
        
        // Detect golf ball specifically
        function detectGolfBall(prediction) {
            const [x, y, width, height] = prediction.bbox;
            
            // Calculate ball center
            const centerX = x + width / 2;
            const centerY = y + height / 2;
            
            // Store previous position
            if (ballPosition) {
                previousBallPosition = { ...ballPosition };
            }
            
            // Update ball position
            ballPosition = {
                x: centerX,
                y: centerY,
                radius: width / 2,
                timestamp: Date.now()
            };
            
            // Calculate velocity if we have previous position
            if (previousBallPosition) {
                const dt = (ballPosition.timestamp - previousBallPosition.timestamp) / 1000;
                if (dt > 0) {
                    ballVelocity.x = (ballPosition.x - previousBallPosition.x) / dt;
                    ballVelocity.y = (ballPosition.y - previousBallPosition.y) / dt;
                }
            }
            
            // Add to trail
            ballTrail.push({ ...ballPosition });
            if (ballTrail.length > 30) {
                ballTrail.shift();
            }
        }
        
        // Track ball movement
        function trackBall() {
            if (!ballPosition) return;
            
            // Draw ball tracker
            const tracker = document.createElement('div');
            tracker.className = 'ball-tracker';
            tracker.style.left = `${ballPosition.x - ballPosition.radius}px`;
            tracker.style.top = `${ballPosition.y - ballPosition.radius}px`;
            tracker.style.width = `${ballPosition.radius * 2}px`;
            tracker.style.height = `${ballPosition.radius * 2}px`;
            
            const container = document.getElementById('ballTrackers');
            container.innerHTML = '';
            container.appendChild(tracker);
            
            // Draw trail
            ballTrail.forEach((point, index) => {
                const trail = document.createElement('div');
                trail.className = 'ball-trail';
                trail.style.left = `${point.x}px`;
                trail.style.top = `${point.y}px`;
                trail.style.opacity = index / ballTrail.length;
                container.appendChild(trail);
            });
        }
        
        // Track club movement using edge detection
        function trackClub() {
            // Get image data
            const imageData = processingCtx.getImageData(0, 0, processingCanvas.width, processingCanvas.height);
            
            // Apply edge detection to find club
            const edges = detectEdges(imageData);
            
            // Find club head (look for fast-moving edges)
            const clubHead = findClubHead(edges);
            
            if (clubHead) {
                // Store previous position
                if (clubHeadPosition) {
                    previousClubPosition = { ...clubHeadPosition };
                }
                
                // Update club position
                clubHeadPosition = {
                    x: clubHead.x,
                    y: clubHead.y,
                    timestamp: Date.now()
                };
                
                // Add to path
                clubPath.push({ ...clubHeadPosition });
                if (clubPath.length > 50) {
                    clubPath.shift();
                }
                
                // Calculate club speed
                if (previousClubPosition) {
                    const dt = (clubHeadPosition.timestamp - previousClubPosition.timestamp) / 1000;
                    const dx = clubHeadPosition.x - previousClubPosition.x;
                    const dy = clubHeadPosition.y - previousClubPosition.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const speedPixels = distance / dt;
                    const speedMeters = speedPixels / pixelsPerMeter;
                    const speedMPH = speedMeters * 2.237;
                    
                    // Update display
                    document.getElementById('swingSpeed').textContent = `${Math.round(speedMPH)} mph`;
                }
            }
        }
        
        // Edge detection for club tracking
        function detectEdges(imageData) {
            const width = imageData.width;
            const height = imageData.height;
            const data = imageData.data;
            const edges = new Uint8ClampedArray(width * height);
            
            // Sobel edge detection
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    
                    // Get surrounding pixels
                    const tl = data[((y - 1) * width + (x - 1)) * 4];
                    const tm = data[((y - 1) * width + x) * 4];
                    const tr = data[((y - 1) * width + (x + 1)) * 4];
                    const ml = data[(y * width + (x - 1)) * 4];
                    const mr = data[(y * width + (x + 1)) * 4];
                    const bl = data[((y + 1) * width + (x - 1)) * 4];
                    const bm = data[((y + 1) * width + x) * 4];
                    const br = data[((y + 1) * width + (x + 1)) * 4];
                    
                    // Sobel X
                    const sobelX = (tr + 2 * mr + br) - (tl + 2 * ml + bl);
                    
                    // Sobel Y
                    const sobelY = (bl + 2 * bm + br) - (tl + 2 * tm + tr);
                    
                    // Magnitude
                    const magnitude = Math.sqrt(sobelX * sobelX + sobelY * sobelY);
                    
                    edges[y * width + x] = magnitude > 50 ? 255 : 0;
                }
            }
            
            return edges;
        }
        
        // Find club head in edge data
        function findClubHead(edges) {
            // Simplified club head detection
            // In production, use more sophisticated tracking
            
            // Look for fast-moving cluster of edges
            // This is a placeholder - real implementation would use:
            // - Optical flow
            // - Template matching
            // - Machine learning model trained on club heads
            
            return null; // Placeholder
        }
        
        // Detect impact between club and ball
        function detectImpact() {
            if (!ballPosition || !clubHeadPosition) return;
            
            // Calculate distance between club and ball
            const dx = clubHeadPosition.x - ballPosition.x;
            const dy = clubHeadPosition.y - ballPosition.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            // Check for impact
            if (distance < ballPosition.radius * 3 && !impactDetected) {
                impactDetected = true;
                onImpact();
            }
        }
        
        // Handle impact detection
        function onImpact() {
            console.log('Impact detected!');
            
            // Calculate shot metrics
            calculateShotMetrics();
            
            // Show metrics
            showMetrics();
            
            // Trigger haptic feedback
            if (navigator.vibrate) {
                navigator.vibrate(100);
            }
            
            // Reset after delay
            setTimeout(() => {
                impactDetected = false;
                ballTrail = [];
                clubPath = [];
            }, 3000);
        }
        
        // Calculate shot metrics from video analysis
        function calculateShotMetrics() {
            // Ball speed from velocity
            const ballSpeedPixels = Math.sqrt(ballVelocity.x ** 2 + ballVelocity.y ** 2);
            const ballSpeedMeters = ballSpeedPixels / pixelsPerMeter;
            shotData.ballSpeed = Math.round(ballSpeedMeters * 2.237); // Convert to mph
            
            // Launch angle from trajectory
            shotData.launchAngle = Math.round(Math.atan2(-ballVelocity.y, ballVelocity.x) * 180 / Math.PI);
            
            // Estimate spin from ball rotation (simplified)
            shotData.spinRate = estimateSpinRate();
            
            // Club speed (already calculated in trackClub)
            shotData.clubSpeed = parseInt(document.getElementById('swingSpeed').textContent) || 0;
            
            // Smash factor
            shotData.smashFactor = shotData.clubSpeed > 0 ? 
                (shotData.ballSpeed / shotData.clubSpeed).toFixed(2) : 0;
            
            // Estimate carry distance
            shotData.carryDistance = estimateCarryDistance();
            
            // Analyze swing path
            analyzeSwingPath();
        }
        
        // Estimate spin rate from ball appearance
        function estimateSpinRate() {
            // In production, analyze ball dimple blur or use dual-camera setup
            // For now, use typical values based on launch angle
            
            if (shotData.launchAngle < 10) {
                return 2500 + Math.random() * 500; // Driver spin
            } else if (shotData.launchAngle < 15) {
                return 4000 + Math.random() * 1000; // Iron spin
            } else {
                return 7000 + Math.random() * 2000; // Wedge spin
            }
        }
        
        // Estimate carry distance
        function estimateCarryDistance() {
            // Simplified trajectory calculation
            const v0 = shotData.ballSpeed * 0.44704; // mph to m/s
            const angle = shotData.launchAngle * Math.PI / 180;
            const spinEffect = 1 + (shotData.spinRate - 3000) * 0.00002;
            
            const carry = (v0 * v0 * Math.sin(2 * angle) / 9.81) * spinEffect;
            return Math.round(carry * 1.094); // Convert to yards
        }
        
        // Analyze swing path from club tracking
        function analyzeSwingPath() {
            if (clubPath.length < 10) return;
            
            // Get path at impact zone
            const impactPath = clubPath.slice(-10);
            
            // Calculate path direction
            const startX = impactPath[0].x;
            const endX = impactPath[impactPath.length - 1].x;
            const pathDirection = endX - startX;
            
            if (Math.abs(pathDirection) < 5) {
                shotData.swingPath = 'Straight';
            } else if (pathDirection > 5) {
                shotData.swingPath = 'In-to-Out';
            } else {
                shotData.swingPath = 'Out-to-In';
            }
            
            // Update display
            document.getElementById('swingPath').textContent = shotData.swingPath;
        }
        
        // Show metrics display
        function showMetrics() {
            const metricsDisplay = document.getElementById('metricsDisplay');
            metricsDisplay.style.display = 'block';
            
            // Update values
            document.getElementById('ballSpeed').textContent = shotData.ballSpeed;
            document.getElementById('launchAngle').textContent = `${shotData.launchAngle}°`;
            document.getElementById('spinRate').textContent = Math.round(shotData.spinRate);
            document.getElementById('carryDistance').textContent = shotData.carryDistance;
            document.getElementById('clubSpeed').textContent = shotData.clubSpeed;
            document.getElementById('smashFactor').textContent = shotData.smashFactor;
            
            // Show swing analysis
            document.getElementById('swingAnalysis').style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                metricsDisplay.style.display = 'none';
                document.getElementById('swingAnalysis').style.display = 'none';
            }, 5000);
        }
        
        // Draw detection box
        function drawDetectionBox(prediction) {
            const box = document.createElement('div');
            box.className = 'detection-box';
            box.style.left = `${prediction.bbox[0]}px`;
            box.style.top = `${prediction.bbox[1]}px`;
            box.style.width = `${prediction.bbox[2]}px`;
            box.style.height = `${prediction.bbox[3]}px`;
            
            const label = document.createElement('div');
            label.className = 'detection-label';
            label.textContent = `${prediction.class} ${Math.round(prediction.score * 100)}%`;
            box.appendChild(label);
            
            document.getElementById('detectionBoxes').appendChild(box);
        }
        
        // Draw AR overlays
        function drawAROverlays() {
            // Draw swing path
            if (clubPath.length > 1) {
                arCtx.strokeStyle = '#00ff88';
                arCtx.lineWidth = 3;
                arCtx.beginPath();
                
                clubPath.forEach((point, index) => {
                    if (index === 0) {
                        arCtx.moveTo(point.x, point.y);
                    } else {
                        arCtx.lineTo(point.x, point.y);
                    }
                });
                
                arCtx.stroke();
            }
            
            // Draw ball trajectory prediction
            if (ballPosition && ballVelocity.x !== 0) {
                arCtx.strokeStyle = '#ff5722';
                arCtx.lineWidth = 2;
                arCtx.setLineDash([5, 5]);
                arCtx.beginPath();
                arCtx.moveTo(ballPosition.x, ballPosition.y);
                
                // Project trajectory
                for (let t = 0; t < 2; t += 0.1) {
                    const x = ballPosition.x + ballVelocity.x * t * 100;
                    const y = ballPosition.y + ballVelocity.y * t * 100 + 0.5 * 9.81 * t * t * pixelsPerMeter;
                    arCtx.lineTo(x, y);
                }
                
                arCtx.stroke();
                arCtx.setLineDash([]);
            }
        }
        
        // Handle pose detection results
        function onPoseResults(results) {
            if (!results.poseLandmarks) return;
            
            // Detect golfer pose
            const landmarks = results.poseLandmarks;
            
            // Analyze stance and posture
            analyzeGolfPosture(landmarks);
        }
        
        // Analyze golf posture
        function analyzeGolfPosture(landmarks) {
            // Get key points
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            
            // Calculate spine angle
            const spineAngle = calculateAngle(
                { x: (leftShoulder.x + rightShoulder.x) / 2, y: (leftShoulder.y + rightShoulder.y) / 2 },
                { x: (leftHip.x + rightHip.x) / 2, y: (leftHip.y + rightHip.y) / 2 }
            );
            
            // Detect swing phase
            if (!swingStartTime && isAddressPosition(landmarks)) {
                swingStartTime = Date.now();
            }
            
            if (swingStartTime) {
                const swingDuration = Date.now() - swingStartTime;
                
                if (swingDuration < 300) {
                    // Backswing
                    document.getElementById('swingTempo').textContent = 'Backswing';
                } else if (swingDuration < 600) {
                    // Downswing
                    document.getElementById('swingTempo').textContent = 'Downswing';
                } else {
                    // Follow through
                    document.getElementById('swingTempo').textContent = 'Follow Through';
                    swingStartTime = null;
                }
            }
        }
        
        // Check if in address position
        function isAddressPosition(landmarks) {
            // Simplified check - arms down, slight bend
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            const wristsLow = leftWrist.y > 0.5 && rightWrist.y > 0.5;
            const hipsBent = (leftHip.y + rightHip.y) / 2 > 0.4;
            
            return wristsLow && hipsBent;
        }
        
        // Calculate angle between points
        function calculateAngle(p1, p2) {
            return Math.atan2(p2.y - p1.y, p2.x - p1.x) * 180 / Math.PI;
        }
        
        // Toggle recording
        function toggleRecording() {
            const btn = document.getElementById('recordBtn');
            
            if (!isRecording) {
                startRecording();
                btn.classList.add('recording');
            } else {
                stopRecording();
                btn.classList.remove('recording');
            }
        }
        
        // Start recording
        function startRecording() {
            isRecording = true;
            recordedFrames = [];
            recordedChunks = [];
            
            // Setup MediaRecorder
            const stream = arCanvas.captureStream(30);
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/webm'
            });
            
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                
                // Show in result
                document.getElementById('resultVideo').src = url;
                showShotResult();
            };
            
            mediaRecorder.start();
        }
        
        // Stop recording
        function stopRecording() {
            isRecording = false;
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }
        
        // Record frame
        function recordFrame() {
            // Store frame data for analysis
            recordedFrames.push({
                timestamp: Date.now(),
                ballPosition: ballPosition ? { ...ballPosition } : null,
                clubPosition: clubHeadPosition ? { ...clubHeadPosition } : null
            });
        }
        
        // Show shot result
        function showShotResult() {
            document.getElementById('shotResult').style.display = 'flex';
            
            // Update result metrics
            document.getElementById('resultBallSpeed').textContent = shotData.ballSpeed;
            document.getElementById('resultClubSpeed').textContent = shotData.clubSpeed;
            document.getElementById('resultCarry').textContent = shotData.carryDistance;
            document.getElementById('resultSmash').textContent = shotData.smashFactor;
        }
        
        // Close result
        function closeResult() {
            document.getElementById('shotResult').style.display = 'none';
        }
        
        // Toggle settings
        function toggleSettings() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('open');
        }
        
        // Set detection mode
        function setDetectionMode(mode) {
            document.querySelectorAll('.setting-option').forEach(opt => {
                opt.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update detection mode
            console.log('Detection mode:', mode);
        }
        
        // Set camera quality
        async function setCameraQuality(quality) {
            document.querySelectorAll('.setting-option').forEach(opt => {
                opt.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update camera constraints
            let constraints;
            switch(quality) {
                case 'high':
                    constraints = { width: 1920, height: 1080 };
                    break;
                case 'medium':
                    constraints = { width: 1280, height: 720 };
                    break;
                case 'low':
                    constraints = { width: 640, height: 480 };
                    break;
            }
            
            // Apply new constraints
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { ...constraints, frameRate: { ideal: 240 } }
            });
            video.srcObject = stream;
        }
        
        // Set frame rate
        async function setFrameRate(fps) {
            document.querySelectorAll('.setting-option').forEach(opt => {
                opt.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update camera frame rate
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    frameRate: { ideal: fps }
                }
            });
            video.srcObject = stream;
        }
        
        // Close help
        function closeHelp() {
            document.getElementById('helpOverlay').style.display = 'none';
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    toggleRecording();
                    break;
                case 'h':
                    document.getElementById('helpOverlay').style.display = 'flex';
                    break;
                case 'Escape':
                    closeResult();
                    closeHelp();
                    break;
            }
        });
        
        console.log('Vision Golf Pro initialized');
        console.log('Using AI computer vision for ball and club tracking');
    </script>
</body>
</html>
